"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("./log.cjs.js");async function t(r,i){var{headers:l,response:s={},method:a=(i.post?"POST":i.put?"PUT":i.patch?"PATCH":"GET"),cache:d=!1,cacheForTime:c=60,timeout:u=30,baseURL:g="undefined"!=typeof process&&process.env.SERVER_API_URL||"/api/",cancelOngoingIfNew:f=!1,cancelNewIfOngoing:p=!1,rateLimit:b=0,debug:m=!1,infiniteScroll:y=null,setDefaults:w=!1,retryAttempts:h=0,logger:v=e.log,onRequest:T=null,onResponse:S=null,onError:L=null,onStream:x=null,repeatEvery:O=null,repeat:E=0,debounce:k=0,regrabOnStale:N=!1,regrabOnFocus:j=!1,regrabOnNetwork:P=!1,post:D=!1,put:q=!1,patch:J=!1,body:A=null,...F}={..."undefined"!=typeof window?window?.grab?.defaults:(global||globalThis)?.grab?.defaults||{},...i};let R=e=>r.startsWith(e);R("http:")||R("https:")?g="":R("/")||g.endsWith("/")?R("/")&&g.endsWith("/")&&(r=r.slice(1)):r="/"+r;try{if(k>0)return await o(async()=>{await t(r,{...i,debounce:0})},1e3*k);if(E>1){for(let e=0;e<E;e++)await t(r,{...i,repeat:0});return s}if(O)return setInterval(async()=>{await t(r,{...i,repeat:0,repeatEvery:null})},1e3*O),s;if(i?.setDefaults)return void("undefined"!=typeof window?window.grab.defaults={...i,setDefaults:void 0}:void 0!==(global||globalThis).grab&&((global||globalThis).grab.defaults={...i,setDefaults:void 0}));if("undefined"!=typeof window){const e=async()=>await t(r,{...i,cache:!1});N&&d&&setTimeout(e,1e3*c),P&&window.addEventListener("online",e),j&&(window.addEventListener("focus",e),document.addEventListener("visibilitychange",async()=>{"visible"===document.visibilityState&&await e()}))}let n="function"==typeof s?s:null;s&&!n||(s={});var[$,I,H]=y||[];if(y?.length&&void 0!==H&&"undefined"!=typeof window){let o="string"==typeof H?document.querySelector(H):H;o?window.scrollListener&&void 0!==o&&"function"==typeof o.removeEventListener&&o.removeEventListener("scroll",window.scrollListener):e.log("paginateDOM not found",{color:"red"}),window.scrollListener=async e=>{const o=e.target;localStorage.setItem("scroll",JSON.stringify([o.scrollTop,o.scrollLeft,H])),o.scrollHeight-o.scrollTop<=o.clientHeight+200&&await t(r,{...i,cache:!1,[$]:h?.currentPage+1})},o&&o.addEventListener("scroll",window.scrollListener)}let w=JSON.stringify($?{...F,[$]:void 0}:F),h=t?.log?.find(e=>e.request==w&&e.path==r);if($){let e=h?.currentPage+1||F?.[$]||1;h||(s[I]=[],e=1),h&&(h.currentPage=e),F={...F,[$]:e}}else{for(let e of Object.keys(s))s[e]=void 0;if(d&&(!c||h?.lastFetchTime>Date.now()-1e3*c)){for(let e of Object.keys(h.res))s[e]=h.res[e];n&&(s=n(s))}}if(n?n({isLoading:!0}):"object"==typeof s&&(s.isLoading=!0),n&&(s=n(s)),b>0&&h?.lastFetchTime&&h.lastFetchTime>Date.now()-1e3*b)throw new Error(`Fetch rate limit exceeded for ${r}. \n        Wait ${b}s between requests.`);if(h?.controller)if(f)h.controller.abort();else if(p)return{isLoading:!0};void 0!==t.log&&t.log?.unshift({path:r,request:w,lastFetchTime:Date.now(),controller:new AbortController});let L={method:a,headers:{"Content-Type":"application/json",Accept:"application/json",...l},body:F.body,redirect:"follow",cache:d?"force-cache":"no-store",signal:f?t.log[0]?.controller?.signal:AbortSignal.timeout(1e3*u)},D="";["POST","PUT","PATCH"].includes(a)?L.body=F.body||JSON.stringify(F):D=(Object.keys(F).length?"?":"")+new URLSearchParams(F).toString(),"function"==typeof T&&([r,s,F,L]=T(r,s,F,L));let q=null,J=new Date,A=t.mock?.[r],R=e=>new Promise(t=>setTimeout(t,1e3*e||0));if(!A||A.params&&A.method!=a||A.params&&w!=JSON.stringify(A.params)){if(q=await fetch(g+r+D,L).catch(e=>{throw new Error(e.message)}),!q.ok)throw new Error(`HTTP error: ${q.status} ${q.statusText}`);let e=q.headers.get("content-type");x?await x(q.body):q=await(e?e.includes("application/json")?q&&q.json():e.includes("application/pdf")||e.includes("application/octet-stream")?q.blob():q.text():q.json()).catch(e=>{throw new Error("Error parsing response: "+e)})}else await R(A.delay),q="function"==typeof A.response?A.response(F):A.response;"function"==typeof S&&([r,s,F,L]=S(r,s,F,L)),n?n({isLoading:void 0}):"object"==typeof s&&delete s?.isLoading,delete h?.controller;const C=((Number(new Date)-Number(J))/1e3).toFixed(1);if(m&&v("Path:"+g+r+D+"\n"+JSON.stringify(i,null,2)+"\nTime: "+C+"s\nResponse: "+e.printJSONStructure(q)),"object"==typeof q){for(let e of Object.keys(q))s[e]=I==e&&s[e]?.length?[...s[e],...q[e]]:q[e];void 0!==s&&(s.data=q)}else n?n({data:q,...q}):"object"==typeof s&&(s.data=q);return void 0!==t.log&&t.log?.unshift({path:r,request:JSON.stringify({...F,paginateKey:void 0}),response:s,lastFetchTime:Date.now()}),n&&(s=n(s)),s}catch(C){let e="Error: "+C.message+"\nPath:"+g+r+"\n";return"function"==typeof L&&L(C.message,g+r,F),i.retryAttempts>0?await t(r,{...i,retryAttempts:--i.retryAttempts}):(!C.message.includes("signal")&&i.debug&&(v(e,{color:"red"}),m&&"undefined"!=typeof document&&n(e)),s.error=C.message,"function"==typeof s?(s.data=s({isLoading:void 0,error:C.message}),s=s.data):delete s?.isLoading,void 0!==t.log&&t.log?.unshift({path:r,request:JSON.stringify(F),error:C.message}),s)}}t.instance=(e={})=>(o,n={})=>t(o,{...e,...n});const o=async(e,t)=>{let o;return async function(...n){clearTimeout(o),o=setTimeout(async()=>{clearTimeout(o),await e(...n)},t)}};function n(e){if("undefined"==typeof document)return;let t,o=document.getElementById("alert-overlay");o||(o=document.body.appendChild(document.createElement("div")),o.id="alert-overlay",o.setAttribute("style","position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center"),o.innerHTML='<div id="alert-box" style="background:#fff;padding:1.5em 2em;border-radius:8px;box-shadow:0 2px 16px #0003;min-width:220px;max-height:80vh;position:relative;display:flex;flex-direction:column;">\n      <button id="close-alert" style="position:absolute;top:12px;right:20px;font-size:1.5em;background:none;border:none;cursor:pointer;color:black;">&times;</button>\n      <div id="alert-list" style="overflow:auto;flex:1;"></div>\n    </div>',o.addEventListener("click",e=>e.target==o&&o.remove()),document.getElementById("close-alert").onclick=()=>o.remove()),t=o.querySelector("#alert-list"),t.innerHTML+=`<div style="border-bottom:1px solid #333; font-size:1.2em;margin:0.5em 0;">${e}</div>`}function r(){document.addEventListener("keydown",o=>{if("i"===o.key&&o.ctrlKey&&o.altKey){let o=" ";for(let n of t.log)o+=`<div style="margin-bottom:1em; border-bottom:1px solid #ccc; padding-bottom:1em;">\n          <b>Path:</b> ${n.path}<br>\n          <b>Request:</b> ${e.printJSONStructure(n.request,0,"html")}<br>\n          <b>Response:</b> ${e.printJSONStructure(n.response,0,"html")}<br> \n          <b>Time:</b> ${new Date(n.lastFetchTime).toLocaleString()}\n        </div>`;n(o)}})}"undefined"!=typeof window?(window.log=e.log,window.grab=t,window.grab.log=[],window.grab.mock={},window.grab.defaults={},r(),document.addEventListener("DOMContentLoaded",()=>{let[e,t,o]=JSON.parse(localStorage.getItem("scroll"))||[];e&&(document.querySelector(o).scrollTop=e,document.querySelector(o).scrollLeft=t)})):"undefined"!=typeof global?(t.log=[],t.mock={},t.defaults={},global.log=e.log,global.grab=t.instance()):"undefined"!=typeof globalThis&&(t.log=[],t.mock={},t.defaults={},globalThis.log=e.log,globalThis.grab=t.instance()),exports.log=e.log,exports.printJSONStructure=e.printJSONStructure,exports.default=t,exports.grab=t,exports.setupDevTools=r,exports.showAlert=n;
//# sourceMappingURL=grab-api.cjs.js.map
